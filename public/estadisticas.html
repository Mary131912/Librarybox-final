<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Mi Biblioteca</title>
    <link rel="stylesheet" href="styles-new.css">
</head>
<body>
    <div class="dashboard-wrapper">
        <nav class="dashboard-nav">
            <div class="nav-brand">
                <div class="brand-icon">üìä</div>
                <div class="brand-text">
                    <h1>Estad√≠sticas de Lectura</h1>
                    <p>Analiza tus patrones de lectura</p>
                </div>
            </div>
            <div class="nav-user">
                <button class="btn-header" onclick="window.location.href='dashboard-new.html'">üè† Inicio</button>
                <button class="btn-header" onclick="window.location.href='biblioteca-new.html'">üìö Mi Biblioteca</button>
            </div>
        </nav>

        <div class="dashboard-content">
            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                <div class="feature-card">
                    <div class="card-icon">üìö</div>
                    <h3>Total de Libros</h3>
                    <p style="font-size: 3rem; font-weight: 900; color: var(--neon-cyan); margin: 1rem 0;" id="totalLibros">0</p>
                    <p style="color: var(--text-secondary);">En tu colecci√≥n</p>
                </div>

                <div class="feature-card">
                    <div class="card-icon">‚≠ê</div>
                    <h3>Valoraci√≥n Promedio</h3>
                    <p style="font-size: 3rem; font-weight: 900; color: var(--neon-pink); margin: 1rem 0;" id="promedioValoracion">0</p>
                    <p style="color: var(--text-secondary);">De 5 estrellas</p>
                </div>

                <div class="feature-card">
                    <div class="card-icon">üé≠</div>
                    <h3>G√©neros Diferentes</h3>
                    <p style="font-size: 3rem; font-weight: 900; color: var(--neon-purple); margin: 1rem 0;" id="totalGeneros">0</p>
                    <p style="color: var(--text-secondary);">Categor√≠as √∫nicas</p>
                </div>

                <div class="feature-card">
                    <div class="card-icon">‚úçÔ∏è</div>
                    <h3>Autores √önicos</h3>
                    <p style="font-size: 3rem; font-weight: 900; color: var(--neon-green); margin: 1rem 0;" id="totalAutores">0</p>
                    <p style="color: var(--text-secondary);">Diferentes escritores</p>
                </div>
            </div>

            <div class="info-card" style="margin-top: 2rem;">
                <h2 style="margin-bottom: 2rem; color: var(--neon-cyan);">üèÜ Top 5 Mejores Valorados</h2>
                <div id="topLibros" style="display: flex; flex-direction: column; gap: 1rem;">
                    <p style="text-align: center; color: var(--text-secondary);">Cargando estad√≠sticas...</p>
                </div>
            </div>

            <div class="info-card" style="margin-top: 2rem;">
                <h2 style="margin-bottom: 2rem; color: var(--neon-pink);">üìñ G√©neros M√°s Le√≠dos</h2>
                <div id="generosList" style="display: flex; flex-direction: column; gap: 1rem;">
                    <p style="text-align: center; color: var(--text-secondary);">Cargando g√©neros...</p>
                </div>
            </div>

            <div class="info-card" style="margin-top: 2rem;">
                <h2 style="margin-bottom: 2rem; color: var(--neon-purple);">‚úçÔ∏è Autores Favoritos</h2>
                <div id="autoresList" style="display: flex; flex-direction: column; gap: 1rem;">
                    <p style="text-align: center; color: var(--text-secondary);">Cargando autores...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function cargarEstadisticas() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('‚ö†Ô∏è Sesi√≥n no encontrada. Por favor, inicia sesi√≥n.');
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch('/api/libros', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 401) {
                    alert('‚ö†Ô∏è Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.');
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error('Error al cargar libros');
                }

                const data = await response.json();
                const libros = data.libros || [];

                // Calcular estad√≠sticas
                document.getElementById('totalLibros').textContent = libros.length;

                if (libros.length > 0) {
                    // Promedio de valoraci√≥n
                    const librosConValoracion = libros.filter(l => l.valoracion);
                    if (librosConValoracion.length > 0) {
                        const promedio = librosConValoracion.reduce((sum, l) => sum + l.valoracion, 0) / librosConValoracion.length;
                        document.getElementById('promedioValoracion').textContent = promedio.toFixed(1);
                    }

                    // G√©neros √∫nicos
                    const generos = [...new Set(libros.filter(l => l.genero).map(l => l.genero))];
                    document.getElementById('totalGeneros').textContent = generos.length;

                    // Autores √∫nicos
                    const autores = [...new Set(libros.filter(l => l.autor).map(l => l.autor))];
                    document.getElementById('totalAutores').textContent = autores.length;

                    // Top 5 mejores valorados
                    const topLibros = libros
                        .filter(l => l.valoracion)
                        .sort((a, b) => b.valoracion - a.valoracion)
                        .slice(0, 5);
                    
                    if (topLibros.length > 0) {
                        document.getElementById('topLibros').innerHTML = topLibros.map((libro, index) => `
                            <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--dark-elevated); border-radius: 12px; border-left: 4px solid var(--neon-cyan);">
                                <span style="font-size: 2rem; font-weight: 900; color: var(--neon-cyan);">${index + 1}</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: var(--text-primary);">${libro.titulo}</div>
                                    <div style="font-size: 0.9rem; color: var(--text-secondary);">${libro.autor || 'Autor desconocido'}</div>
                                </div>
                                <div style="font-size: 1.5rem; color: var(--neon-pink);">${'‚≠ê'.repeat(libro.valoracion)}</div>
                            </div>
                        `).join('');
                    }

                    // G√©neros m√°s le√≠dos
                    const generoCount = {};
                    libros.filter(l => l.genero).forEach(l => {
                        generoCount[l.genero] = (generoCount[l.genero] || 0) + 1;
                    });
                    const topGeneros = Object.entries(generoCount)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    if (topGeneros.length > 0) {
                        document.getElementById('generosList').innerHTML = topGeneros.map(([genero, count]) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--dark-elevated); border-radius: 12px;">
                                <span style="color: var(--text-primary); font-weight: 600;">${genero}</span>
                                <span style="color: var(--neon-pink); font-weight: 700; font-size: 1.2rem;">${count} libro${count > 1 ? 's' : ''}</span>
                            </div>
                        `).join('');
                    }

                    // Autores favoritos
                    const autorCount = {};
                    libros.filter(l => l.autor).forEach(l => {
                        autorCount[l.autor] = (autorCount[l.autor] || 0) + 1;
                    });
                    const topAutores = Object.entries(autorCount)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    if (topAutores.length > 0) {
                        document.getElementById('autoresList').innerHTML = topAutores.map(([autor, count]) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--dark-elevated); border-radius: 12px;">
                                <span style="color: var(--text-primary); font-weight: 600;">${autor}</span>
                                <span style="color: var(--neon-purple); font-weight: 700; font-size: 1.2rem;">${count} libro${count > 1 ? 's' : ''}</span>
                            </div>
                        `).join('');
                    }
                } else {
                    document.getElementById('topLibros').innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay libros en tu colecci√≥n a√∫n. ¬°Agrega algunos! üìö</p>';
                    document.getElementById('generosList').innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Sin datos de g√©neros</p>';
                    document.getElementById('autoresList').innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Sin datos de autores</p>';
                }
            } catch (error) {
                console.error('Error al cargar estad√≠sticas:', error);
                alert('‚ùå Error al cargar las estad√≠sticas. Verifica que el servidor est√© corriendo.');
            }
        }

        // Verificar sesi√≥n al cargar la p√°gina
        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('‚ö†Ô∏è No has iniciado sesi√≥n.');
                window.location.href = 'login.html';
            } else {
                cargarEstadisticas();
            }
        });
    </script>
</body>
</html>
