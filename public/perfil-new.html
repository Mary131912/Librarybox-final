<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Biblioteca Personal</title>
    <link rel="stylesheet" href="styles-new.css">
</head>
<body>
    <div class="dashboard-wrapper">
        <nav class="dashboard-nav">
            <div class="nav-brand">
                <div class="brand-icon">游녻</div>
                <div class="brand-text">
                    <h1>Mi Perfil</h1>
                    <p>Gestiona tu informaci칩n personal</p>
                </div>
            </div>
            <div class="nav-user">
                <button class="btn-header" onclick="window.location.href='dashboard-new.html'">游 Inicio</button>
                <button class="btn-logout" id="btnCerrarSesion">Cerrar Sesi칩n</button>
            </div>
        </nav>

        <div class="dashboard-content">
            <div id="mensaje" class="mensaje"></div>

            <div class="info-card">
                <h2 style="margin-bottom: 2rem; color: var(--neon-cyan);">游늵 Informaci칩n de la Cuenta</h2>
                
                <div class="info-row">
                    <strong>游닎 Email:</strong>
                    <span id="userEmail">Cargando...</span>
                </div>
                <div class="info-row">
                    <strong>游녻 Nombre:</strong>
                    <span id="userName">Cargando...</span>
                </div>
                <div class="info-row">
                    <strong>游늰 Miembro desde:</strong>
                    <span id="createdAt">Cargando...</span>
                </div>
            </div>

            <div class="info-card" style="margin-top: 2rem;">
                <h2 style="margin-bottom: 2rem; color: var(--neon-pink);">游 Cambiar Contrase침a</h2>
                
                <form id="cambiarPasswordForm">
                    <div class="form-group">
                        <label for="passwordActual">Contrase침a Actual</label>
                        <input type="password" id="passwordActual" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="passwordNueva">Nueva Contrase침a</label>
                        <input type="password" id="passwordNueva" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="passwordConfirmar">Confirmar Nueva Contrase침a</label>
                        <input type="password" id="passwordConfirmar" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Actualizar Contrase침a</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Cargar informaci칩n del usuario
        async function cargarPerfil() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }

                const response = await fetch('/api/usuario', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const usuario = await response.json();
                    document.getElementById('userName').textContent = usuario.nombre;
                    document.getElementById('userEmail').textContent = usuario.email;
                    const fecha = new Date(usuario.fechaCreacion).toLocaleDateString('es-ES');
                    document.getElementById('createdAt').textContent = fecha;
                } else {
                    throw new Error('Error al cargar perfil');
                }
            } catch (error) {
                console.error('Error:', error);
                window.location.href = 'login.html';
            }
        }

        // Cambiar contrase침a
        document.getElementById('cambiarPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const passwordActual = document.getElementById('passwordActual').value;
            const passwordNueva = document.getElementById('passwordNueva').value;
            const passwordConfirmar = document.getElementById('passwordConfirmar').value;

            if (passwordNueva !== passwordConfirmar) {
                mostrarMensaje('Las contrase침as no coinciden', 'error');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/cambiar-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ passwordActual, passwordNueva })
                });

                const result = await response.json();

                if (response.ok) {
                    mostrarMensaje('Contrase침a actualizada exitosamente', 'exito');
                    document.getElementById('cambiarPasswordForm').reset();
                } else {
                    mostrarMensaje(result.mensaje || 'Error al cambiar contrase침a', 'error');
                }
            } catch (error) {
                mostrarMensaje('Error de conexi칩n', 'error');
            }
        });

        // Cerrar sesi칩n
        document.getElementById('btnCerrarSesion').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });

        function mostrarMensaje(texto, tipo) {
            const mensaje = document.getElementById('mensaje');
            mensaje.textContent = texto;
            mensaje.className = `mensaje ${tipo}`;
            setTimeout(() => {
                mensaje.className = 'mensaje';
            }, 5000);
        }

        cargarPerfil();
    </script>
</body>
</html>
